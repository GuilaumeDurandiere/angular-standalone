<div class="background" *ngIf="workflow$ | async as workflow">
    <p class="mandatory-help-text" i18n="@@ALL_FIELDS_MANDATORY">Tous les champs sont obligatoires*</p>
    <form [formGroup]="stepForm">
        <app-form-group-presenter [title]="'Informations étape'">        
            <app-form-control-presenter
                [control]="stepForm.controls.libelle"
                [name]="'stepName'"
                [label]="'Nom de l\'étape'"
                [required]="true"
            >
                <input type="text" pInputText formControlName="libelle" />
            </app-form-control-presenter>
            <app-form-control-presenter
                [control]="stepForm.controls.description"
                [name]="'stepDescription'"
                [label]="'Description de l\'étape'"
            >
                <input type="text" pInputText formControlName="description" />
            </app-form-control-presenter>
            <app-form-control-presenter
                [control]="stepForm.controls.statut"
                [name]="'stepStatus'"
                [label]="'Statut'"
                [required]="true"
            >
                <input type="text" pInputText formControlName="statut" />
            </app-form-control-presenter>
            @if (step.id === 0) {
                <p class="subtitle" i18n="@@SUBSTEP_INFO_FAC">Informations sous-étapes <span class="facultative">(facultatif)</span></p>
                <div formArrayName="sousEtapes">
                    <div
                        class="substep-container p-3 mb-2"
                        *ngFor="let control of sousEtapes.controls; let i = index"
                    >
                        <div class="d-flex justify-content-between">
                            <p class="substep-name" i18n="@@SUBSTEP_NUMBER">Sous-étape {{i + 1}}</p>
                            <span (click)="onRemoveSubstep(i)" class="pi pi-times-circle"></span>
                        </div>
                        <app-add-substep-form [formControlName]="i"></app-add-substep-form>
                    </div>
                </div>
                <button
                    pButton
                    pRipple
                    i18n-label="@@ADD_SUBSTEP"
                    label="Ajouter une sous-étape"
                    icon="pi pi-plus-circle"
                    class="add-substep-button"
                    (click)="onAddSubstep()"
                ></button>
            }
        </app-form-group-presenter>
        <div class="d-flex justify-content-between">
            <button
                pButton
                pRipple
                i18n-label="@@CANCEL"
                label="Annuler"
                icon="pi pi-times"
                class="cancel-button"
                (click)="closeDialog()"
            ></button>
            @if (step.id === 0) {
                <button
                    pButton
                    pRipple
                    [disabled]="stepForm.invalid"
                    i18n-label="@@ADD_STEP"
                    label="Ajouter l'étape"
                    icon="pi pi-plus-circle"
                    class="generic-button"
                    (click)="onCreateSubmit(stepForm, workflow.id)"
                ></button>
            } @else {
                <button
                    pButton
                    pRipple
                    [disabled]="stepForm.invalid"
                    i18n-label="@@SAVE_STEP"
                    label="Enregistrer les modifications"
                    icon="pi pi-save"
                    class="generic-button"
                    (click)="onUpdateSubmit(stepForm, workflow.id)"
                ></button>
            }
        </div>
    </form>
</div>